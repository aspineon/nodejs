<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Contacts</title>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-theme.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
<div class="container">
    <form id="contactForm" class="well">
        <div class="form-group">
            <label for="name">Full name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Full name">
        </div>
        <div class="form-group">
            <label for="email">Email address</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="Email address">
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone">
        </div>
        <input type="hidden">
        <button type="button" class="btn btn-default">Cancel</button>
        <button type="button" class="btn btn-info">Save</button>
    </form>
</div>
<div id="cards"></div>
<script src="node_modules/mustache/mustache.js"></script>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
<script>
    $(function () {
        let contactTemplate = '',
            isContactSelected = false,
            contactForm = $('#contactForm'),
            cards = $("#cards"),
            contacts = [];

        function setFormData(contact) {
            if (contact) {
                $('input:eq(0)', contactForm).val(contact.name);
                $('input:eq(1)', contactForm).val(contact.email);
                $('input:eq(2)', contactForm).val(contact.phone);
                $('input:eq(3)', contactForm).val(contact.id);
            }
        }

        function initSaveButton() {
            let saveButton = $('button:eq(1)', contactForm);
            let formState = contactForm.serialize();
            saveButton.attr("disabled", true);
            $('form :input').on('change input', function() {
                saveButton.attr("disabled", contactForm.serialize() === formState);
            });
        }

        function getFormData() {
            return {
                name: $('input:eq(0)', contactForm).val(),
                email: $('input:eq(1)', contactForm).val(),
                phone: $('input:eq(2)', contactForm).val(),
                id: +$('input:eq(3)', contactForm).val()
            };
        }

        function getContactById(id) {
            return contacts.find(function (contact) {
                return contact.id === id;
            });
        }

        function saveContact(contact) {
            $.extend(getContactById(contact.id), contact);
        }

        function initCards() {
            $('.card').on('click', function () {
                let id = $(this).data("id");
                let contact = getContactById(id);
                setFormData(contact);
                initSaveButton();
                contactForm.toggle(true);
            });
        }

        function renderContact(template, contact) {
            return Mustache.render(contactTemplate, contact);
        }

        function renderContacts() {
            let result = contacts.reduce((result, contact) => result += renderContact(contactTemplate, contact), '');
            cards.html(result);
        }

        function refresh() {
            renderContacts();
            initCards();
        }

        function initForm() {
            $('button:eq(0)', contactForm).on('click', () => {
                contactForm.toggle(false);
            });
            $('button:eq(1)', contactForm).on('click', () => {
                saveContact(getFormData());
                contactForm.toggle(false);
                renderContacts();
                initCards();
            });
        }

        function loadContactTemplate() {
            return $.ajax('assets/templates/contact.html');
        }

        function loadContacts() {
            return $.ajax('data/contacts.json');
        }

        $.when(loadContactTemplate(), loadContacts()).done((template, data) => {
            contactTemplate = template[0];
            contacts = data[0];
            initForm();
            refresh();
        });
    });
</script>
</body>
</html>